<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Chelsea Dining & Bars Guide (Personal)</title>

<style>
body{margin:0;display:flex;height:100vh;font-family:Helvetica,Arial,sans-serif;color:#333;}
.list{width:45%;min-width:350px;padding:20px;overflow-y:auto;box-shadow:inset -1px 0 0 #ddd;}
.mapwrap{flex:1;min-width:320px;}
#google-map-iframe{width:100%;height:100%;border:0;}
.card{padding:10px 0;border-bottom:1px solid #eee; position: relative;}
.card:hover{background:#f5f5f5;}
.index{font-weight:bold;margin-right:4px;}
.price{color:#28a745;font-weight:bold;margin-left:6px;}
.tags{font-size:.8em;color:#555;}
.blurb{font-size: .9em; display: block; margin-top: 3px;}
em {font-size: .9em; color: #666;}
a.restLink { text-decoration: none; color: #333; font-weight: bold;}
a.restLink:hover { text-decoration: underline; }

h2{margin:18px 0 6px;font-size:1.15em;border-bottom:1px solid #999;padding-bottom:4px}
.filter{margin-bottom:12px;font-size:.9em;}
.add-place-form { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
.add-place-form h3 { margin: 0 0 10px; font-size: 1em; }
.form-row { display: flex; gap: 10px; margin-bottom: 10px; }
.form-row input, .form-row select { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
.form-row button { padding: 8px 12px; border: none; background-color: #28a745; color: white; font-weight: bold; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
.form-row button:hover { background-color: #218838; }

.delete-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 1.5em; color: #ccc; cursor: pointer; line-height: 1; padding: 2px 5px; transition: color 0.2s; }
.delete-btn:hover { color: #e74c3c; }

.my-rating-container { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
.my-rating-label { font-size: .85em; font-weight: bold; }
.my-star { font-size: 1.4em; color: #ccc; cursor: pointer; transition: color 0.2s; }
.my-star.hover { color: #6eb3e8; }
.my-star.filled { color: #3498db; }
.my-notes-container { margin-top: 6px; }
.my-notes { font-size: .9em; font-style: italic; color: #555; padding: 4px 6px; border: 1px dashed #ddd; border-radius: 4px; width: calc(100% - 14px); transition: background-color 0.2s, border-color 0.2s; }
.my-notes:focus { background-color: #f8f9fa; border-color: #3498db; outline: none; }
.my-notes:empty::before { content: 'Click to add your notes...'; color: #999; font-style: italic; }
</style>
</head>
<body>
<div class="list">
  <div class="add-place-form">
      <h3>Add a New Place</h3>
      <form id="addPlaceForm">
          <div class="form-row"> <input type="text" id="newPlaceName" placeholder="Name of Restaurant, Bar, etc." required> </div>
          <div class="form-row"> <select id="newPlaceCategory" required></select> <button type="submit">Add Place</button> </div>
      </form>
  </div>
  <div class="filter"> Show: <select id="catFilter"> <option value="all">All</option> </select> </div>
  <div id="cardsContainer"></div>
</div>
<div class="mapwrap"> <iframe id="google-map-iframe" src="https://www.google.com/maps/d/u/0/embed?mid=100ZEopn8tzgiICHrXjovi7Bvjckynjs&ehbc=2E312F" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe> </div>

<script>
function initPage(){

const HOME = { lat:40.746936, lon:-73.993135 };
const USER_DATA_KEY = 'myChelseaRestaurantData';
const USER_PLACES_KEY = 'myChelseaUserAddedPlaces';

const CATEGORIES = {
    top:"üíé Top-Tier",main:"ü•Ç Mainstream",chinese:"ü•ü Chinese / Dim Sum",pizza:"üçï Pizza",bagels:"ü•Ø Bagels",
    desserts:"üç∞ Desserts",gelato:"üç® Gelato",pastries:"ü•ê Bread & Pastries",bars:"üç∏ Bars & Cocktails"
};

// --- DATA STORAGE & MANAGEMENT ---
function loadUserAddedPlaces() {
    return JSON.parse(localStorage.getItem(USER_PLACES_KEY) || '[]');
}

function saveUserAddedPlaces(places) {
    localStorage.setItem(USER_PLACES_KEY, JSON.stringify(places));
}

let baseData = [
    {idx:1,name:"Eleven Madison Park",cat:"top",price:"$$$$",cuisine:"Modern American",url:"https://www.elevenmadisonpark.com", blurb:"Daniel Humm‚Äôs three-star icon pivoted to an all-plant menu without losing the sense of theater.", dish:"Must-order: the sunflower butter bread service."},
    {idx:2,name:"Atomix",cat:"top",price:"$$$$",cuisine:"Korean Tasting",url:"https://www.atomixnyc.com", blurb:"A 14-seat counter where each course is presented with a collectible card explaining Korean ingredients.", dish:"Must-order: abalone juk with seaweed butter."},
    {idx:3,name:"COTE Korean Steakhouse",cat:"top",price:"$$$$",cuisine:"Korean BBQ",url:"https://www.cotekoreansteakhouse.com", blurb:"The world‚Äôs only Michelin-starred K-BBQ marries dry-aged beef with a clubby cocktail bar.", dish:"Must-order: Butcher‚Äôs Feast (prime ribeye & marinated short rib)."},
    {idx:4,name:"Ai Fiori",cat:"top",price:"$$$$",cuisine:"French-Italian",url:"https://www.aifiorinyc.com", blurb:"Chef Michael White‚Äôs Riviera-inspired pastas and seafood served from a marble grand staircase.", dish:"Must-order: lobster velout√© with black-truffle gnocchetti."},
    {idx:5,name:"Koloman",cat:"top",price:"$$$$",cuisine:"Austro-French",url:"https://www.kolomanrestaurant.com", blurb:"Markus Glocker reinvents Viennese classics in an art-nouveau room inside the Ace Hotel.", dish:"Must-order: vanilla souffl√© with elderflower cr√®me-anglaise."},
    {idx:6,name:"Gramercy Tavern",cat:"top",price:"$$$$",cuisine:"New American",url:"https://www.gramercytavern.com", blurb:"Danny Meyer‚Äôs wood-beamed standby still defines warm service and seasonal cooking.", dish:"Must-order: smoked trout with horseradish & dill."},
    {idx:7,name:"Rezd√¥ra",cat:"top",price:"$$$$",cuisine:"Emilia-Romagna Italian",url:"https://www.rezdora.nyc", blurb:"Hand-rolled pasta ritual from Osteria Francescana alumnus Stefano Secchi.", dish:"Must-order: grandma walking through forest mushroom pasta."},
    {idx:8,name:"The Clocktower",cat:"top",price:"$$$$",cuisine:"Modern British",url:"https://www.theclocktowernyc.com", blurb:"Jason Atherton‚Äôs mahogany dining rooms hide inside the Edition Hotel‚Äôs turn-of-the-century clocktower.", dish:"Must-order: beef Wellington for two."},
    {idx:9,name:"Noda",cat:"top",price:"$$$$",cuisine:"Edomae Sushi",url:"https://www.noda.nyc", blurb:"Eight seats, hinoki counter, 14-course omakase flown in from Toyosu Market daily.", dish:"Must-order: aged bluefin akami with shark-skin wasabi."},
    {idx:10,name:"Gabriel Kreuther",cat:"top",price:"$$$$",cuisine:"Alsatian French",url:"https://www.gknyc.com", blurb:"Stork murals and bacon bread introduce chef Kreuther‚Äôs luxe take on Alsace.", dish:"Must-order: sturgeon sauerkraut tart with caviar."},
    {idx:11,name:"Shukette",cat:"main",price:"$$",cuisine:"Middle Eastern",url:"https://www.shukettenyc.com", blurb:"Chef Ayesha Nurdjaja‚Äôs rowdy grill counter sends out blistered laffa and za‚Äôatar-dusted fries.", dish:"Must-order: Jaffa feast (whole fish, salatim, laffa)."},
    {idx:12,name:"Txikito",cat:"main",price:"$$",cuisine:"Basque",url:"https://www.txikitonyc.com", blurb:"Tiny bar where pintxos arrive pinned with toothpicks and Spanish vermouth flows on tap.", dish:"Must-order: morcilla & egg ‚Äòslider‚Äô (Bikini Txistorra)."},
    {idx:13,name:"Cookshop",cat:"main",price:"$$",cuisine:"Seasonal American",url:"https://www.cookshopny.com", blurb:"Locavore brunch magnet across from the High Line‚Äîsolar panels power the kitchen.", dish:"Must-order: wood-fired shakshuka."},
    {idx:14,name:"Hav & Mar",cat:"main",price:"$$$",cuisine:"Afro-Nordic Seafood",url:"https://www.havandmar.com", blurb:"Marcus Samuelsson marries Ethiopian spice with Scandinavian technique.", dish:"Must-order: berbere-spiced whole branzino."},
    {idx:15,name:"ABC Kitchen",cat:"main",price:"$$$",cuisine:"Farm-to-Table",url:"https://www.abckitchennyc.com", blurb:"Jean-Georges‚Äô original farm-to-table room lit by reclaimed chandeliers.", dish:"Must-order: roasted carrot & avocado salad."},
    {idx:16,name:"La Pecora Bianca",cat:"main",price:"$$",cuisine:"Italian",url:"https://www.lapecorabianca.com", blurb:"All-day spritzes and house-made rigatoni in a bright, tile-lined room.", dish:"Must-order: pesto gramigna with sausage."},
    {idx:17,name:"L‚ÄôAmico",cat:"main",price:"$$$",cuisine:"Italian-American",url:"https://www.lamico.nyc", blurb:"Hotel Eventi‚Äôs hearth-fed pizzas and pastas by Laurent Tourondel.", dish:"Must-order: cacio-e-pepe focaccia."},
    {idx:18,name:"Legacy Records",cat:"main",price:"$$$",cuisine:"Italian",url:"https://www.legacyrecordsrestaurant.com", blurb:"Charlie Bird team‚Äôs swanky dining room tucked into a Hudson Yards condo tower.", dish:"Must-order: chicken liver agnolotti."},
    {idx:19,name:"Ci Siamo",cat:"main",price:"$$$",cuisine:"Live-Fire Italian",url:"https://www.cisiamonyc.com", blurb:"Hillary Sterling‚Äôs open-hearth kitchen perfumes the room with smoldering olive logs.", dish:"Must-order: focaccia di Recco with stracchino."},
    {idx:20,name:"Kyma Flatiron",cat:"main",price:"$$",cuisine:"Greek",url:"https://www.kymaflatiron.com", blurb:"White-washed Cycladic dining room turns out whole grilled lavraki and ouzo cocktails.", dish:"Must-order: saganaki cheese with Metaxa flamb√©."},
    {idx:21,name:"Dim Sum Sam",cat:"chinese",price:"$$",cuisine:"Dim Sum",url:"https://dimsumsam.com", blurb:"Counter-service baskets of steamed shrimp har-gow and rice rolls made to order.", dish:"Must-order: molten salted-egg yolk buns."},
    {idx:22,name:"Hao Noodle",cat:"chinese",price:"$$$",cuisine:"Chongqing Noodles",url:"https://www.haonoodle.com", blurb:"Floral china and silk lanterns set the stage for numbing-spicy beef noodles.", dish:"Must-order: grandma‚Äôs chicken soup noodles."},
    {idx:23,name:"Xi‚Äôan Famous Foods",cat:"chinese",price:"$$",cuisine:"Shaanxi",url:"https://xianfoods.com", blurb:"Hand-torn biang-biang ribbons slicked with cumin-lamb chili oil.", dish:"Must-order: spicy cumin lamb noodles."},
    {idx:24,name:"Mala Project",cat:"chinese",price:"$$",cuisine:"Dry-Pot Sichuan",url:"https://malaproject.nyc", blurb:"Build-your-own Sichuan dry pot with 50+ mix-ins, no broth required.", dish:"Must-order: lotus root & beef-tongue dry pot."},
    {idx:25,name:"RedFarm",cat:"chinese",price:"$$$",cuisine:"NYC Chinese-Fusion",url:"https://redfarmnyc.com", blurb:"Playful dim-sum like Pac-Man shrimp dumplings in a barn-chic room.", dish:"Must-order: Katz‚Äôs pastrami egg roll."},
    {idx:26,name:"Junzi Kitchen",cat:"chinese",price:"$$",cuisine:"Northern Chinese",url:"https://junzi.kitchen", blurb:"Fast-casual chun-bing wraps filled with cumin lamb and sweet potato noodles.", dish:"Must-order: jianbing-style scallion pancake."},
    {idx:27,name:"Han Dynasty",cat:"chinese",price:"$$",cuisine:"Sichuan",url:"https://handynasty.net", blurb:"Philadelphia import famed for its ‚Äòdry pepper‚Äô crispy wings.", dish:"Must-order: dan-dan noodles level-6 spice."},
    {idx:28,name:"Spicy Village Express",cat:"chinese",price:"$",cuisine:"Henan",url:"https://spicyvillagenyc.com", blurb:"Mini offshoot slings the legendary big-plate chicken over hand-pulled noodles.", dish:"Must-order: big plate chicken for two."},
    {idx:29,name:"Noodle Q",cat:"chinese",price:"$",cuisine:"Hand-Pulled Noodles",url:"#", blurb:"No-frills counter for Lanzhou-style beef noodle soup with ribbons as wide as belts.", dish:"Must-order: extra-wide noodles in clear broth."},
    {idx:30,name:"Brooklyn Dumpling Shop",cat:"chinese",price:"$",cuisine:"Automat Dumplings",url:"https://brooklyndumplingshop.com", blurb:"24-hour Automat serves cheeseburger and Philly cheese-steak dumplings from lockers.", dish:"Must-order: pastrami dumplings with mustard."},
    {idx:31,name:"NY Pizza Suprema",cat:"pizza",price:"$",cuisine:"Slice Joint",url:"https://nypizzasuprema.com", blurb:"50-year Penn Station slice legend‚Äîsauce first, cheese second.", dish:"Must-order: upside-down Sicilian slice."},
    {idx:32,name:"Joe‚Äôs Pizza ‚Äì 24th St",cat:"pizza",price:"$",cuisine:"Classic NY",url:"https://www.joespizzanyc.com", blurb:"West Village icon‚Äôs Chelsea outpost keeps the foldable triangles flowing till 4 AM.", dish:"Must-order: plain cheese slice, extra crisp."},
    {idx:33,name:"Lucali Slice",cat:"pizza",price:"$$",cuisine:"Brick-Oven",url:"#", blurb:"Counter spin-off of Carroll Gardens cult favorite‚Äîsame sweet basil sauce by the slice. (Reported Closed)", dish:"Must-order: pepperoni & hot honey."},
    {idx:34,name:"Starita",cat:"pizza",price:"$$",cuisine:"Neapolitan",url:"https://staritanapoli.com", blurb:"Legendary Naples pizzeria‚Äôs lightly fried montanara pies land in NoMad.", dish:"Must-order: Montanara Margherita (flash-fried crust)."},
    {idx:35,name:"Prince St Pizza Chelsea",cat:"pizza",price:"$",cuisine:"Square Slice",url:"https://princestpizzanyc.com", blurb:"Soho‚Äôs spicy ‚Äòroni cups migrate uptown‚Äîbe prepared for a queue.", dish:"Must-order: Spicy Spring square slice."},
    {idx:36,name:"Scarr‚Äôs Express",cat:"pizza",price:"$",cuisine:"Whole-Wheat Slice",url:"https://scarrspizza.com", blurb:"Milled-in-house flour yields a 70s-style slice with better chew.", dish:"Must-order: plain slice; add Sicilian if hot."},
    {idx:37,name:"Artichoke Basille‚Äôs",cat:"pizza",price:"$",cuisine:"Late-Night",url:"https://artichokepizza.com", blurb:"Rich, creamy artichoke-spinach slice that eats like lasagna at 3 AM.", dish:"Must-order: artichoke slice, obviously."},
    {idx:38,name:"Two Boots Flatiron",cat:"pizza",price:"$",cuisine:"Cajun Slice",url:"https://twoboots.com", blurb:"Cornmeal crust and andouille toppings meet punk-rock decor.", dish:"Must-order: Bayou Beast slice."},
    {idx:39,name:"Slice Joint",cat:"pizza",price:"$",cuisine:"Thin Crust",url:"https://slicejointpizza.com", blurb:"Paper-thin squares cooked in blue-steel pans by a Roberta‚Äôs alum.", dish:"Must-order: sausage & fennel round slice."},
    {idx:40,name:"Lombardi‚Äôs Chelsea",cat:"pizza",price:"$$",cuisine:"Coal-Oven",url:"https://firstpizza.com", blurb:"Offshoot of America‚Äôs first licensed pizzeria uses the same coal-blistered crust. (Reported Closed)", dish:"Must-order: Margherita with fresh basil."},
    {idx:41,name:"Black Seed Bagels",cat:"bagels",price:"$",cuisine:"Montreal-NY",url:"https://blackseedbagels.com", blurb:"Honey-water boiled, wood-fired bagels with smoked-trout spread.", dish:"Must-order: Everything bagel + scallion cream cheese."},
    {idx:42,name:"Brooklyn Bagel & Coffee",cat:"bagels",price:"$",cuisine:"Classic NY",url:"https://www.brooklynbagelandcoffeecompany.com", blurb:"Queens-born outfit famous for bacon-scallion cream cheese.", dish:"Must-order: French toast bagel, toasted."},
    {idx:43,name:"Bagel Market",cat:"bagels",price:"$",cuisine:"Modern Bagel",url:"https://thebagelmarket.com", blurb:"Rainbow bagels and over-stuffed breakfast sandwiches.", dish:"Must-order: ‚ÄòHungry Man‚Äô egg & bacon bagel."},
    {idx:44,name:"Ess-a-Bagel 6th Ave",cat:"bagels",price:"$",cuisine:"Classic NY",url:"https://www.ess-a-bagel.com", blurb:"Pillow-soft, nearly pound-heavy bagels piled high with lox.", dish:"Must-order: classic lox & scallion on everything."},
    {idx:45,name:"Liberty Bagels",cat:"bagels",price:"$",cuisine:"Loaded Bagels",url:"https://libertybagels.com", blurb:"Fruity-pebble rainbow bagels and 25+ cream-cheese flavors.", dish:"Must-order: Liberty Deluxe turkey BLT."},
    {idx:46,name:"Bo‚Äôs Bagels Nomad",cat:"bagels",price:"$",cuisine:"Harlem Export",url:"https://www.bosbagels.com", blurb:"Hand-rolled, 24-hour fermented dough yields proper chew.", dish:"Must-order: pimento-cheese everything bagel."},
    {idx:47,name:"Best Bagel & Coffee",cat:"bagels",price:"$",cuisine:"Deluxe Bagel",url:"https://bestbagelandcoffee.com", blurb:"Monstrous sandwiches feed commuters near Penn Station.", dish:"Must-order: pastrami-egg-cheese on sesame."},
    {idx:48,name:"Murray‚Äôs Bagels",cat:"bagels",price:"$",cuisine:"Classic",url:"https://murraysbagels.com", blurb:"Boiled-baked West Village institution‚Äîno toasted bagels before noon!", dish:"Must-order: whitefish salad on pumpernickel."},
    {idx:49,name:"Tompkins Square Bagels West",cat:"bagels",price:"$",cuisine:"Creative Spreads",url:"https://tompkinssquarebagels.com", blurb:"Birthday-cake cream cheese meets hand-rolled bagels.", dish:"Must-order: cinnamon-raisin + birthday-cake spread."},
    {idx:50,name:"Hudson Bagels",cat:"bagels",price:"$",cuisine:"Hand-Rolled",url:"https://hudsonbagelsnyc.com", blurb:"Newcomer boiling malted dough the old-school way.", dish:"Must-order: classic plain + veggie spread."},
    {idx:51,name:"Pop-Up Bagels",cat:"bagels",price:"$$",cuisine:"Pop-Up",url:"https://popupbagels.com", blurb:"Award-winning, Connecticut-born bagel pop-up (now permanent) with schmear flights.", dish:"Must-order: maple-bacon cream cheese with hot-everything bagel."},
    {idx:52,name:"Morgenstern‚Äôs Ice Cream",cat:"desserts",price:"$$",cuisine:"Ice Cream",url:"https://www.morgensternsnyc.com", blurb:"Chef-driven scoops like burnt-honey vanilla & Vietnamese coffee.", dish:"Must-order: raw-milk chocolate soft serve."},
    {idx:53,name:"Milk Bar Flagship",cat:"desserts",price:"$",cuisine:"American Bakery",url:"https://milkbarstore.com", blurb:"Christina Tosi‚Äôs cereal-milk soft-serve and compost cookies.", dish:"Must-order: birthday-cake truffles six-pack."},
    {idx:54,name:"Sprinkles Cupcakes",cat:"desserts",price:"$",cuisine:"Cupcakes",url:"https://www.sprinkles.com", blurb:"ATM cupcake machine dispenses red-velvet 24/7.", dish:"Must-order: red-velvet cupcake with cream-cheese frosting."},
    {idx:55,name:"Lady M Cake Boutique",cat:"desserts",price:"$$$",cuisine:"French-Japanese Cakes",url:"https://ladym.com", blurb:"20-layer mille-cr√™pe cakes so thin they melt on contact.", dish:"Must-order: green-tea mille-cr√™pe slice."},
    {idx:56,name:"Dominique Ansel Workshop",cat:"desserts",price:"$$$",cuisine:"Pastry Lab",url:"https://dominiqueansel.com", blurb:"Cronut¬Æ creator‚Äôs R&D kitchen turns out kouign-amann and cookie shots.", dish:"Must-order: monthly Cronut¬Æ flavor (arrive early!)."},
    {idx:57,name:"Amorino Gelato",cat:"gelato",price:"$",cuisine:"Gelato",url:"https://www.amorino.com", blurb:"Rose-shaped gelato scoops piled into a petal bouquet.", dish:"Must-order: pistachio & mango gelato rose."},
    {idx:58,name:"Spot Dessert Bar",cat:"desserts",price:"$$",cuisine:"Asian Fusion Desserts",url:"https://www.spotdessertbar.com", blurb:"Instagrammable ‚ÄòHarvest‚Äô parfait looks like a potted plant.", dish:"Must-order: matcha lava cake."},
    {idx:59,name:"Levain Bakery",cat:"desserts",price:"$",cuisine:"Cookies",url:"https://levainbakery.com", blurb:"Half-pound, molten-center cookies with cult following.", dish:"Must-order: dark-chocolate peanut-butter chip cookie."},
    {idx:60,name:"Chip City",cat:"desserts",price:"$",cuisine:"Cookies",url:"https://chipcitycookies.com", blurb:"Rotating cookie board changes daily‚Äîexpect gooey centers.", dish:"Must-order: cannoli-cream cookie (Fridays)."},
    {idx:61,name:"Eileen‚Äôs Cheesecake",cat:"desserts",price:"$",cuisine:"Cheesecake",url:"https://eileenscheesecake.com", blurb:"Fluffy, crusted, personal cheesecakes from Soho legend‚Äôs kiosk.", dish:"Must-order: strawberry-topped mini cheesecake."},
    {idx:62,name:"Sullivan Street Bakery",cat:"pastries",price:"$$",cuisine:"Italian Bread",url:"https://sullivanstreetbakery.com", blurb:"Jim Lahey‚Äôs no-knead Roman bakery‚Äîfamous for potato pizza slices.", dish:"Must-order: sheet-pan potato pizza square."},
    {idx:63,name:"Breads Bakery Chelsea",cat:"pastries",price:"$$",cuisine:"Israeli Bakery",url:"https://breadsbakery.com", blurb:"Chocolate babka that dethroned Zabar‚Äôs in a blind taste test.", dish:"Must-order: chocolate babka loaf."},
    {idx:64,name:"Mah-Ze-Dahr",cat:"pastries",price:"$$",cuisine:"Artisan Bakery",url:"https://mahzedahrbakery.com", blurb:"James Beard-winning pastry chef Umber Ahmad‚Äôs gluten dreamland.", dish:"Must-order: brown-butter brioche doughnut."},
    {idx:65,name:"Daily Provisions 23rd",cat:"pastries",price:"$",cuisine:"All-Day Caf√©",url:"https://dailyprovisions.com", blurb:"Union Square Hospitality spin-off known for crullers and breakfast sandwiches.", dish:"Must-order: maple-glazed cruller."},
    {idx:66,name:"Fabrique Bakery",cat:"pastries",price:"$$",cuisine:"Swedish Bakery",url:"https://fabriqueusa.com", blurb:"Imported stone oven bakes cardamom-scented knots all day.", dish:"Must-order: cardamom bun."},
    {idx:67,name:"Lafayette Grand Bakery",cat:"pastries",price:"$$$",cuisine:"French Bakery",url:"https://lafayetteny.com", blurb:"Creator of the viral ‚ÄòSupreme‚Äô croissant rolls.", dish:"Must-order: pistachio raspberry ‚ÄòSupreme‚Äô (arrive by 8 a.m.)."},
    {idx:68,name:"Ole & Steen",cat:"pastries",price:"$$",cuisine:"Danish Bakery",url:"https://oleandsteen.us", blurb:"Copenhagen chain‚Äôs first U.S. store‚Äîsticky cinnamon ‚Äòsocial slice‚Äô.", dish:"Must-order: cinnamon social slab."},
    {idx:69,name:"Pain d‚ÄôAvignon",cat:"pastries",price:"$$",cuisine:"French Bakery",url:"https://paindavignon-nyc.com", blurb:"Cape Cod bakery‚Äôs NYC outpost: crusty miche and kouign-amann.", dish:"Must-order: ham & cheese croissant."},
    {idx:70,name:"Culture Espresso Bakery",cat:"pastries",price:"$",cuisine:"Coffee & Cookies",url:"https://cultureespresso.com", blurb:"Third-wave espresso with gooey chocolate-chip cookies.", dish:"Must-order: triple-chocolate cookie."},
    {idx:71,name:"Patisserie Chanson",cat:"pastries",price:"$$",cuisine:"Modern French",url:"https://patisseriechanson.com", blurb:"Sous-vide cheesecakes & matcha croissants under pastel arches.", dish:"Must-order: black-sesame Paris-Brest."},
    {idx:72,name:"Paris Baguette",cat:"pastries",price:"$",cuisine:"Korean Bakery",url:"https://parisbaguette.com", blurb:"Global chain‚Äôs Chelsea flagship stacking strawberry cream cakes.", dish:"Must-order: milk-cream bread roll."},
    {idx:73, name:"Superbueno",cat:"bars", price:"$$$", cuisine:"Mexican Cocktails", url:"https://www.superbuenonyc.com", blurb:"Playful Mexican cocktail bar with creative drinks and small bites.", dish:"Signature Drink: Mushroom Margarita"},
    {idx:74, name:"Sip & Guzzle",cat:"bars", price:"$$$", cuisine:"Dual Concept Cocktail Bar", url:"https://www.sipandguzzlenyc.com", blurb:"Upstairs 'Sip' offers refined cocktails, downstairs 'Guzzle' is more casual.", dish:"Signature Drink: Try the clarified cocktails"},
    {idx:75, name:"Overstory",cat:"bars", price:"$$$$", cuisine:"Rooftop Cocktails", url:"https://www.overstory-nyc.com", blurb:"Stunning views from the 64th floor with sophisticated cocktails.", dish:"Signature Drink: Martini variation"},
    {idx:76, name:"Clemente Bar",cat:"bars", price:"$$$", cuisine:"Lower East Side Cocktails", url:"#", blurb:"Chic LES bar known for good vibes and well-made drinks.", dish:"Signature Drink: Check seasonal menu"},
    {idx:77, name:"Martiny's",cat:"bars", price:"$$$$", cuisine:"Elegant Japanese Cocktails", url:"https://martinysnyc.com", blurb:"Gramercy townhouse bar focused on precise, elegant Japanese cocktail technique.", dish:"Signature Drink: Classic Martini"},
    {idx:78, name:"Employees Only",cat:"bars", price:"$$$", cuisine:"Speakeasy Cocktails", url:"https://employeesonlynyc.com", blurb:"Iconic West Village speakeasy known for classic cocktails and late-night food.", dish:"Signature Drink: EO Gimlet"},
    {idx:79, name:"Double Chicken Please",cat:"bars", price:"$$$", cuisine:"Creative Cocktails & Food", url:"https://doublechickenplease.com", blurb:"Front room has cocktails on tap & fried chicken; back room has highly conceptual drinks.", dish:"Signature Drink: Cold Pizza cocktail"},
    {idx:80, name:"Maison Premiere",cat:"bars", price:"$$$", cuisine:"Oyster Bar & Cocktails", url:"https://maisonpremiere.com", blurb:"New Orleans-inspired Williamsburg bar with extensive oyster selection and absinthe cocktails.", dish:"Signature Drink: Absinthe Colada"},
    {idx:81, name:"Katana Kitten",cat:"bars", price:"$$$", cuisine:"Japanese-American Cocktails", url:"https://www.katanakitten.com", blurb:"Highball haven blending Japanese precision with American bar vibes.", dish:"Signature Drink: Hinoki Martini"},
    {idx:82, name:"Angel's Share",cat:"bars", price:"$$$", cuisine:"Speakeasy (Relocated)", url:"https://angelssharenyc.com", blurb:"Legendary Japanese speakeasy, now relocated to the basement of Nakaji.", dish:"Signature Drink: Flirtibird"},
    {idx:83, name:"Dante",cat:"bars", price:"$$$", cuisine:"Negronis & Italian Aperitivo", url:"https://www.dante-nyc.com", blurb:"Historic Caffe Dante, reimagined as an award-winning aperitivo bar famous for Negronis.", dish:"Signature Drink: Negroni Bianco"},
    {idx:84,name:"Anita Gelato",cat:"gelato",price:"$$",cuisine:"Gelato",url:"https://www.anita-gelato.com/", blurb:"Famous for its creamy textures and a signature 'cookieman' flavor.", dish:"Must-order: Cookieman or any fruit sorbet."},
    {idx:85,name:"Grom",cat:"gelato",price:"$$",cuisine:"Gelato",url:"https://www.grom.it/en/", blurb:"Authentic Italian gelato with a focus on high-quality, natural ingredients.", dish:"Must-order: Pistacchio or Crema di Grom."}
];

// Combine base data with user-added data from localStorage
let data = [...baseData, ...loadUserAddedPlaces()];

// --- UI RENDERING & DOM MANIPULATION ---
const catFilterSelect = document.getElementById("catFilter");
const newPlaceCategorySelect = document.getElementById("newPlaceCategory");
Object.keys(CATEGORIES).forEach(key => {
    const optionHTML = `<option value="${key}">${CATEGORIES[key].substring(2)}</option>`;
    catFilterSelect.insertAdjacentHTML('beforeend', optionHTML);
    newPlaceCategorySelect.insertAdjacentHTML('beforeend', optionHTML);
});

const cardHTML = r => `
<div class="card ${r.cat}" id="card${r.idx}">
  <button class="delete-btn" data-idx="${r.idx}" title="Delete this place">√ó</button>
  <span class="index">${r.idx}.</span>
  <a class="restLink" href="${r.url || '#'}" target="_blank">${r.name}</a>
  <span class="price">${r.price}</span><br>
  <span class="tags">${r.cuisine}</span><br>
  ${ r.blurb ? `<span class="blurb">${r.blurb}</span><br>` : "" }
  ${ r.dish  ? `<em>${r.dish}</em>` : "" }
  <div class="my-rating-container">
      <span class="my-rating-label">My Rating:</span>
      <div class="my-rating-stars" data-idx="${r.idx}">
          ${[1,2,3,4,5].map(i => `<span class="my-star" data-value="${i}">‚òÜ</span>`).join('')}
      </div>
  </div>
  <div class="my-notes-container">
      <div class="my-notes" contenteditable="true" data-idx="${r.idx}"></div>
  </div>
</div>`;

function renderAllCards() {
    const list = document.getElementById("cardsContainer");
    list.innerHTML = ''; // Clear container before rendering
    Object.keys(CATEGORIES).forEach(cat=>{
        const categoryData = data.filter(d => d.cat === cat);
        // Only render the category heading if it has items
        if (categoryData.length > 0) {
            list.insertAdjacentHTML("beforeend", `<h2 id="heading-${cat}">${CATEGORIES[cat]}</h2>`);
            const categoryCardContainer = document.createElement('div');
            categoryCardContainer.id = `cards-container-${cat}`;
            list.appendChild(categoryCardContainer);
            categoryData.forEach(d => {
                categoryCardContainer.insertAdjacentHTML("beforeend", cardHTML(d));
            });
        }
    });
    // Re-attach all listeners after re-rendering
    document.querySelectorAll('.card').forEach(attachAllActionListeners);
    applyAllUserData();
}

document.getElementById("catFilter").addEventListener("change",()=>{
    const sel = document.getElementById("catFilter").value;
    document.querySelectorAll('.card').forEach(card => {
        const cardCategory = Array.from(card.classList).find(c => CATEGORIES[c]);
        card.style.display = (sel === 'all' || cardCategory === sel) ? "block" : "none";
    });
    document.querySelectorAll('#cardsContainer h2').forEach(h2 => {
        const container = h2.nextElementSibling;
        if(container) {
            const hasVisibleCards = container.querySelector('.card[style*="display: block"]');
            h2.style.display = hasVisibleCards ? 'block' : 'none';
        }
    });
});

// --- GOOGLE API & DATA FETCHING ---
let gService;
try {
    gService = new google.maps.places.PlacesService(document.createElement('div'));
} catch (e) { console.error("Error initializing Google Places Service.", e); return; }

function injectRating(cardId, avg, total){
  const node = document.getElementById(cardId);
  if(!node || !avg || !total) return;
  const renderStars = a => {
      let h='<span style="color:#f4b400;font-size:1.1em;line-height:1;">';
      for(let i=0;i<5;i++)h+=i<Math.floor(a)?'‚òÖ':'‚òÜ';
      return h+'</span>';
  };
  let ratingDiv = node.querySelector('.google-rating');
  if (!ratingDiv) {
      ratingDiv = document.createElement('div');
      ratingDiv.className = 'google-rating';
      ratingDiv.style.cssText = 'margin-top: 4px; font-size: 0.85em;';
      const myRatingContainer = node.querySelector('.my-rating-container');
      if (myRatingContainer) {
        node.insertBefore(ratingDiv, myRatingContainer);
      }
  }
  ratingDiv.innerHTML = `${renderStars(avg)} ${avg.toFixed(1)} (${total.toLocaleString()} reviews)`;
}

function extractMustOrder(reviews) {
    if (!reviews || reviews.length === 0) return 'Must-order: TBD';
    const keywords = ['must order','must try','must-try','must have','get the','order the','loved the','favorite was the','recommend the',"don't miss the"];
    for (const review of reviews) {
        const reviewText = review.text.toLowerCase();
        for (const keyword of keywords) {
            const keywordIndex = reviewText.indexOf(keyword);
            if (keywordIndex > -1) {
                let snippet = review.text.substring(keywordIndex + keyword.length).trim().replace(/^:/, '').trim();
                const terminators = ['.', '!', ',', ' and ', ' but '];
                let endIndex = -1;
                terminators.forEach(term => {
                    const termIndex = snippet.indexOf(term);
                    if (termIndex > -1 && (endIndex === -1 || termIndex < endIndex)) endIndex = termIndex;
                });
                let dish = (endIndex > -1 ? snippet.substring(0, endIndex) : snippet.split(' ').slice(0, 5).join(' ')).trim();
                if (dish && dish.length > 3 && dish.length < 50) return `Must-order: ${dish.charAt(0).toUpperCase() + dish.slice(1)}`;
            }
        }
    }
    return 'Must-order: TBD';
}

// --- EVENT HANDLERS & LISTENERS ---
function handleDeletePlace(event) {
    const idxToDelete = event.target.dataset.idx;
    const cardElement = document.getElementById(`card${idxToDelete}`);
    const placeName = cardElement.querySelector('.restLink').textContent;
    if (confirm(`Are you sure you want to delete "${placeName}"? This cannot be undone.`)) {
        data = data.filter(item => item.idx != idxToDelete);
        let userAddedPlaces = loadUserAddedPlaces();
        userAddedPlaces = userAddedPlaces.filter(item => item.idx != idxToDelete);
        saveUserAddedPlaces(userAddedPlaces);
        let userData = JSON.parse(localStorage.getItem(USER_DATA_KEY) || '{}');
        delete userData[idxToDelete];
        localStorage.setItem(USER_DATA_KEY, JSON.stringify(userData));
        const categoryContainer = cardElement.parentElement;
        cardElement.remove();
        if (categoryContainer && categoryContainer.children.length === 0) {
            const heading = categoryContainer.previousElementSibling;
            if(heading && heading.tagName === 'H2') {
                heading.remove();
            }
            categoryContainer.remove();
        }
    }
}

function handleAddPlace(event) {
    event.preventDefault();
    const nameInput = document.getElementById('newPlaceName');
    const placeName = nameInput.value.trim();
    if (!placeName) return;

    gService.textSearch({
        query: `${placeName}, New York, NY`, fields: ['place_id'], locationBias: new google.maps.LatLng(HOME.lat, HOME.lon)
    }, (results, status) => {
        if (status !== 'OK' || !results || !results[0]) { alert(`Could not find "${placeName}". Please try a more specific name.`); return; }
        
        // ** THE FIX IS HERE: Requesting the correct 'website' field **
        gService.getDetails({
            placeId: results[0].place_id,
            fields: ['name', 'url', 'website', 'geometry', 'price_level', 'types', 'rating', 'user_ratings_total', 'reviews']
        }, (place, detailsStatus) => {
            if (detailsStatus !== 'OK') { alert("Could not fetch details for that place."); return; }
            
            const newIndex = data.length > 0 ? Math.max(...data.map(d => d.idx)) + 1 : 1;
            const selectedCategory = document.getElementById('newPlaceCategory').value;
            const newPlace = {
                idx: newIndex, name: place.name, cat: selectedCategory,
                price: place.price_level ? '$'.repeat(place.price_level) : '$$',
                cuisine: place.types && place.types[0] ? place.types[0].replace(/_/g, ' ').replace(/\b\w/g, l=>l.toUpperCase()) : 'N/A',
                url: place.website || place.url, // Prefer the official website URL if it exists
                blurb: `Added by you on ${new Date().toLocaleDateString()}`,
                dish: extractMustOrder(place.reviews), 
                placeId: place.place_id, 
                isUserAdded: true,
                // Also save rating info so we don't need to re-fetch it
                rating: place.rating,
                reviews: place.user_ratings_total
            };
            
            data.push(newPlace);
            let userAddedPlaces = loadUserAddedPlaces();
            userAddedPlaces.push(newPlace);
            saveUserAddedPlaces(userAddedPlaces);
            
            let container = document.getElementById(`cards-container-${newPlace.cat}`);
            let heading = document.getElementById(`heading-${newPlace.cat}`);
            if (!container) { // If category doesn't exist on page yet, create it
                renderAllCards(); // Easiest way to add the new heading and container correctly
                container = document.getElementById(`cards-container-${newPlace.cat}`);
            } else {
                 container.insertAdjacentHTML('beforeend', cardHTML(newPlace));
            }

            if(heading && heading.style.display === 'none') {
                 heading.style.display = 'block';
            }

            const newCardNode = document.getElementById(`card${newIndex}`);
            attachAllActionListeners(newCardNode);
            if (newPlace.rating) {
                injectRating(`card${newIndex}`, newPlace.rating, newPlace.reviews);
            }
            applyAllUserData();
            nameInput.value = '';
            newCardNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
    });
}

function attachAllActionListeners(cardNode) {
    cardNode.querySelector('.delete-btn')?.addEventListener('click', handleDeletePlace);
    
    const starContainer = cardNode.querySelector('.my-rating-stars');
    if (starContainer) {
        starContainer.addEventListener('mouseover', e => {
            const hoverValue = parseInt(e.target.dataset.value, 10);
            if (!hoverValue) return;
            starContainer.querySelectorAll('.my-star').forEach(s => {
                s.innerHTML = parseInt(s.dataset.value) <= hoverValue ? '‚òÖ' : '‚òÜ';
                s.classList.add('hover');
            });
        });
        starContainer.addEventListener('mouseout', () => {
            const userData = JSON.parse(localStorage.getItem(USER_DATA_KEY) || '{}');
            const savedRating = userData[starContainer.dataset.idx]?.rating || 0;
            starContainer.querySelectorAll('.my-star').forEach(s => {
                s.innerHTML = parseInt(s.dataset.value) <= savedRating ? '‚òÖ' : '‚òÜ';
                s.classList.remove('hover');
                s.classList.toggle('filled', parseInt(s.dataset.value) <= savedRating);
            });
        });
        starContainer.addEventListener('click', e => {
            const rating = parseInt(e.target.dataset.value, 10);
            if (!rating) return;
            const idx = starContainer.dataset.idx;
            let userData = JSON.parse(localStorage.getItem(USER_DATA_KEY) || '{}');
            if (!userData[idx]) userData[idx] = {};
            userData[idx].rating = userData[idx].rating === rating ? 0 : rating;
            localStorage.setItem(USER_DATA_KEY, JSON.stringify(userData));
            starContainer.dispatchEvent(new Event('mouseout'));
        });
    }

    const notesField = cardNode.querySelector('.my-notes');
    if (notesField) {
        notesField.addEventListener('blur', () => {
            const idx = notesField.dataset.idx;
            let userData = JSON.parse(localStorage.getItem(USER_DATA_KEY) || '{}');
            if (!userData[idx]) userData[idx] = {};
            userData[idx].notes = notesField.innerText.trim();
            localStorage.setItem(USER_DATA_KEY, JSON.stringify(userData));
        });
    }
}

function applyAllUserData() {
    const userData = JSON.parse(localStorage.getItem(USER_DATA_KEY) || '{}');
    Object.keys(userData).forEach(idx => {
        const cardNode = document.getElementById(`card${idx}`);
        if (!cardNode) return;
        const itemData = userData[idx];
        if (itemData.rating) {
            const starContainer = cardNode.querySelector('.my-rating-stars');
            if(starContainer) {
                starContainer.dispatchEvent(new Event('mouseout'));
            }
        }
        if (itemData.notes) {
            const notesField = cardNode.querySelector('.my-notes');
            if (notesField) notesField.innerText = itemData.notes;
        }
    });
}

// --- INITIALIZATION ---
renderAllCards();
data.forEach(r => {
    // Fetch ratings only for the base data. User-added places have ratings saved.
    if (!r.isUserAdded) {
         gService.textSearch({ query: `${r.name}, New York, NY`, fields: ['rating', 'user_ratings_total'] },
         (results, status) => {
             if (status === 'OK' && results && results[0] && results[0].rating) {
                 injectRating(`card${r.idx}`, results[0].rating, results[0].user_ratings_total);
             }
         });
    } else if (r.rating) { // For user-added places that already have rating data.
        injectRating(`card${r.idx}`, r.rating, r.reviews);
    }
});
document.getElementById('addPlaceForm').addEventListener('submit', handleAddPlace);
document.getElementById("catFilter").dispatchEvent(new Event('change'));

} // End of initPage function
</script>

<!-- IMPORTANT: Replace YOUR_API_KEY with your actual Google Maps API Key -->
<script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAKPWb_1blb8G_kwcJfQ2AVu0VvLYiTviM&libraries=places&callback=initPage"></script>

</body>
</html>
