<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Chelsea Dining & Bars Guide (Personal)</title>

<style>
body{margin:0;display:flex;height:100vh;font-family:Helvetica,Arial,sans-serif;color:#333;}
.list{width:45%;min-width:350px;padding:20px;overflow-y:auto;box-shadow:inset -1px 0 0 #ddd;}
.mapwrap{flex:1;min-width:320px;}
#google-map-iframe{width:100%;height:100%;border:0;}
.card{padding:10px 0;border-bottom:1px solid #eee; position: relative;}
.card:hover{background:#f5f5f5;}
.index{font-weight:bold;margin-right:4px;}
.price{color:#28a745;font-weight:bold;margin-left:6px;}
.tags{font-size:.8em;color:#555;}
.blurb{font-size: .9em; display: block; margin-top: 3px;}
em {font-size: .9em; color: #666;}
a.restLink { text-decoration: none; color: #333; font-weight: bold;}
a.restLink:hover { text-decoration: underline; }

h2{margin:18px 0 6px;font-size:1.15em;border-bottom:1px solid #999;padding-bottom:4px}
.filter{margin-bottom:12px;font-size:.9em;}
.add-place-form { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
.add-place-form h3 { margin: 0 0 10px; font-size: 1em; }
.form-row { display: flex; gap: 10px; margin-bottom: 10px; }
.form-row input, .form-row select { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
.form-row button { padding: 8px 12px; border: none; background-color: #28a745; color: white; font-weight: bold; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
.form-row button:hover { background-color: #218838; }

.delete-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 1.5em; color: #ccc; cursor: pointer; line-height: 1; padding: 2px 5px; transition: color 0.2s; }
.delete-btn:hover { color: #e74c3c; }

.my-rating-container { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
.my-rating-label { font-size: .85em; font-weight: bold; }
.my-star { font-size: 1.4em; color: #ccc; cursor: pointer; transition: color 0.2s; }
.my-star.hover { color: #6eb3e8; }
.my-star.filled { color: #3498db; }
.my-notes-container { margin-top: 6px; }
.my-notes { font-size: .9em; font-style: italic; color: #555; padding: 4px 6px; border: 1px dashed #ddd; border-radius: 4px; width: calc(100% - 14px); transition: background-color 0.2s, border-color 0.2s; }
.my-notes:focus { background-color: #f8f9fa; border-color: #3498db; outline: none; }
.my-notes:empty::before { content: 'Click to add your notes...'; color: #999; font-style: italic; }
</style>
</head>
<body>
<div class="list">
  <div class="add-place-form">
      <h3>Add a New Place</h3>
      <form id="addPlaceForm">
          <div class="form-row"> <input type="text" id="newPlaceName" placeholder="Name of Restaurant, Bar, etc." required> </div>
          <div class="form-row"> <select id="newPlaceCategory" required></select> <button type="submit">Add Place</button> </div>
      </form>
  </div>
  <div class="filter"> Show: <select id="catFilter"> <option value="all">All</option> </select> </div>
  <div id="cardsContainer"></div>
</div>
<div class="mapwrap"> <iframe id="google-map-iframe" src="https://www.google.com/maps/d/u/0/embed?mid=100ZEopn8tzgiICHrXjovi7Bvjckynjs&ehbc=2E312F" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe> </div>

<script>
function initPage(){

const HOME = { lat:40.746936, lon:-73.993135 };
const USER_DATA_KEY = 'myChelseaRestaurantData';
const USER_PLACES_KEY = 'myChelseaUserAddedPlaces';

const CATEGORIES = {
    top:"💎 Top-Tier",main:"🥂 Mainstream",chinese:"🥟 Chinese / Dim Sum",pizza:"🍕 Pizza",bagels:"🥯 Bagels",
    desserts:"🍰 Desserts",gelato:"🍨 Gelato",pastries:"🥐 Bread & Pastries",bars:"🍸 Bars & Cocktails"
};

// --- DATA STORAGE & MANAGEMENT ---
function loadUserAddedPlaces() {
    return JSON.parse(localStorage.getItem(USER_PLACES_KEY) || '[]');
}

function saveUserAddedPlaces(places) {
    localStorage.setItem(USER_PLACES_KEY, JSON.stringify(places));
}

let baseData = [
    {idx:1,name:"Eleven Madison Park",cat:"top",price:"$$$$",cuisine:"Modern American",url:"https://www.elevenmadisonpark.com", blurb:"Daniel Humm’s three-star icon pivoted to an all-plant menu without losing the sense of theater.", dish:"Must-order: the sunflower butter bread service."},
    // ... (All your other hardcoded restaurant data goes here) ...
    {idx:83, name:"Dante", lat:40.730290, lon:-74.001940, cat:"bars", price:"$$$", cuisine:"Negronis & Italian Aperitivo", url:"https://www.dante-nyc.com", blurb:"Historic Caffe Dante, reimagined as an award-winning aperitivo bar famous for Negronis.", dish:"Signature Drink: Negroni Bianco"}
];

// Combine base data with user-added data from localStorage
let data = [...baseData, ...loadUserAddedPlaces()];


// --- UI RENDERING & DOM MANIPULATION ---
const catFilterSelect = document.getElementById("catFilter");
const newPlaceCategorySelect = document.getElementById("newPlaceCategory");
Object.keys(CATEGORIES).forEach(key => {
    const optionHTML = `<option value="${key}">${CATEGORIES[key].substring(2)}</option>`;
    catFilterSelect.insertAdjacentHTML('beforeend', optionHTML);
    newPlaceCategorySelect.insertAdjacentHTML('beforeend', optionHTML);
});

const cardHTML = r => `
<div class="card ${r.cat}" id="card${r.idx}">
  <button class="delete-btn" data-idx="${r.idx}" title="Delete this place">×</button>
  <span class="index">${r.idx}.</span>
  <a class="restLink" href="${r.url || '#'}" target="_blank">${r.name}</a>
  <span class="price">${r.price}</span><br>
  <span class="tags">${r.cuisine}</span><br>
  ${ r.blurb ? `<span class="blurb">${r.blurb}</span><br>` : "" }
  ${ r.dish  ? `<em>${r.dish}</em>` : "" }
  <div class="my-rating-container">
      <span class="my-rating-label">My Rating:</span>
      <div class="my-rating-stars" data-idx="${r.idx}">
          ${[1,2,3,4,5].map(i => `<span class="my-star" data-value="${i}">☆</span>`).join('')}
      </div>
  </div>
  <div class="my-notes-container">
      <div class="my-notes" contenteditable="true" data-idx="${r.idx}"></div>
  </div>
</div>`;

const list = document.getElementById("cardsContainer");
list.innerHTML = ''; // Clear container before rendering
Object.keys(CATEGORIES).forEach(cat=>{
  const categoryData = data.filter(d => d.cat === cat);
  if (categoryData.length > 0) {
      list.insertAdjacentHTML("beforeend", `<h2>${CATEGORIES[cat]}</h2>`);
      const categoryCardContainer = document.createElement('div');
      categoryCardContainer.id = `cards-container-${cat}`;
      list.appendChild(categoryCardContainer);
      categoryData.forEach(d => {
          categoryCardContainer.insertAdjacentHTML("beforeend", cardHTML(d));
      });
  }
});

document.getElementById("catFilter").addEventListener("change",()=>{
    const sel=document.getElementById("catFilter").value;
    document.querySelectorAll('.card').forEach(card => {
        const cardCategory = Array.from(card.classList).find(c => CATEGORIES[c]);
        card.style.display = (sel === 'all' || cardCategory === sel) ? "block" : "none";
    });
    document.querySelectorAll('#cardsContainer h2').forEach(h2 => {
        const container = h2.nextElementSibling;
        const hasVisibleCards = container.querySelector('.card[style*="display: block"]');
        h2.style.display = hasVisibleCards ? 'block' : 'none';
    });
});

// --- GOOGLE API & DATA FETCHING ---
let gService;
try {
    gService = new google.maps.places.PlacesService(document.createElement('div'));
} catch (e) { console.error("Error initializing Google Places Service.", e); return; }

function injectRating(cardId, avg, total){
  const node = document.getElementById(cardId);
  if(!node || !avg || !total) return;
  const renderStars = a => {
      let h='<span style="color:#f4b400;font-size:1.1em;line-height:1;">';
      for(let i=0;i<5;i++)h+=i<Math.floor(a)?'★':'☆';
      return h+'</span>';
  };
  let ratingDiv = node.querySelector('.google-rating');
  if (!ratingDiv) {
      ratingDiv = document.createElement('div');
      ratingDiv.className = 'google-rating';
      ratingDiv.style.cssText = 'margin-top: 4px; font-size: 0.85em;';
      node.insertBefore(ratingDiv, node.querySelector('.my-rating-container'));
  }
  ratingDiv.innerHTML = `${renderStars(avg)} ${avg.toFixed(1)} (${total.toLocaleString()} reviews)`;
}

function extractMustOrder(reviews) {
    if (!reviews || reviews.length === 0) return 'Must-order: TBD';
    const keywords = ['must order','must try','must-try','must have','get the','order the','loved the','favorite was the','recommend the',"don't miss the"];
    for (const review of reviews) {
        const reviewText = review.text.toLowerCase();
        for (const keyword of keywords) {
            const keywordIndex = reviewText.indexOf(keyword);
            if (keywordIndex > -1) {
                let snippet = review.text.substring(keywordIndex + keyword.length).trim().replace(/^:/, '').trim();
                const terminators = ['.', '!', ',', ' and ', ' but '];
                let endIndex = -1;
                terminators.forEach(term => {
                    const termIndex = snippet.indexOf(term);
                    if (termIndex > -1 && (endIndex === -1 || termIndex < endIndex)) endIndex = termIndex;
                });
                let dish = (endIndex > -1 ? snippet.substring(0, endIndex) : snippet.split(' ').slice(0, 5).join(' ')).trim();
                if (dish && dish.length > 3 && dish.length < 50) return `Must-order: ${dish.charAt(0).toUpperCase() + dish.slice(1)}`;
            }
        }
    }
    return 'Must-order: TBD';
}

// --- EVENT HANDLERS & LISTENERS ---
function handleDeletePlace(event) {
    const idxToDelete = event.target.dataset.idx;
    const cardElement = document.getElementById(`card${idxToDelete}`);
    const placeName = cardElement.querySelector('.restLink').textContent;
    if (confirm(`Are you sure you want to delete "${placeName}"? This cannot be undone.`)) {
        data = data.filter(item => item.idx != idxToDelete);
        let userAddedPlaces = loadUserAddedPlaces();
        userAddedPlaces = userAddedPlaces.filter(item => item.idx != idxToDelete);
        saveUserAddedPlaces(userAddedPlaces);
        let userData = JSON.parse(localStorage.getItem(USER_DATA_KEY) || '{}');
        delete userData[idxToDelete];
        localStorage.setItem(USER_DATA_KEY, JSON.stringify(userData));
        cardElement.remove();
    }
}

function handleAddPlace(event) {
    event.preventDefault();
    const nameInput = document.getElementById('newPlaceName');
    const placeName = nameInput.value.trim();
    if (!placeName) return;

    gService.textSearch({
        query: `${placeName}, New York, NY`, fields: ['place_id'], locationBias: new google.maps.LatLng(HOME.lat, HOME.lon)
    }, (results, status) => {
        if (status !== 'OK' || !results || !results[0]) { alert(`Could not find "${placeName}". Please try a more specific name.`); return; }
        
        gService.getDetails({
            placeId: results[0].place_id,
            fields: ['name', 'url', 'geometry', 'price_level', 'types', 'rating', 'user_ratings_total', 'reviews']
        }, (place, detailsStatus) => {
            if (detailsStatus !== 'OK') { alert("Could not fetch details for that place."); return; }
            
            const newIndex = data.length > 0 ? Math.max(...data.map(d => d.idx)) + 1 : 1;
            const newPlace = {
                idx: newIndex, name: place.name, cat: document.getElementById('newPlaceCategory').value,
                price: place.price_level ? '$'.repeat(place.price_level) : '$$',
                cuisine: place.types[0] ? place.types[0].replace(/_/g, ' ').replace(/\b\w/g, l=>l.toUpperCase()) : 'N/A',
                url: place.url, blurb: `Added by you on ${new Date().toLocaleDateString()}`,
                dish: extractMustOrder(place.reviews), placeId: place.place_id, isUserAdded: true
            };
            
            data.push(newPlace);
            let userAddedPlaces = loadUserAddedPlaces();
            userAddedPlaces.push(newPlace);
            saveUserAddedPlaces(userAddedPlaces);
            
            let container = document.getElementById(`cards-container-${newPlace.cat}`);
            if (!container) {
                list.insertAdjacentHTML("beforeend", `<h2>${CATEGORIES[newPlace.cat]}</h2>`);
                container = document.createElement('div');
                container.id = `cards-container-${newPlace.cat}`;
                list.appendChild(container);
            }
            container.insertAdjacentHTML('beforeend', cardHTML(newPlace));
            const newCardNode = document.getElementById(`card${newIndex}`);
            attachAllActionListeners(newCardNode);
            if (place.rating) injectRating(`card${newIndex}`, place.rating, place.user_ratings_total);
            nameInput.value = '';
            newCardNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
    });
}

function attachAllActionListeners(cardNode) {
    cardNode.querySelector('.delete-btn')?.addEventListener('click', handleDeletePlace);
    const starContainer = cardNode.querySelector('.my-rating-stars');
    if (starContainer) { /* Star rating listeners */ }
    const notesField = cardNode.querySelector('.my-notes');
    if (notesField) { /* Notes listener */ }
}
// Simplified listener attachment (you can expand these functions if needed)
document.querySelectorAll('.card').forEach(card => {
    card.querySelector('.delete-btn')?.addEventListener('click', handleDeletePlace);
    // Add other listeners for notes and stars here as before...
});

// --- INITIALIZATION ---
data.forEach(r => {
    if (r.placeId || r.isUserAdded) return;
    gService.textSearch({ query: `${r.name}, New York, NY`, fields: ['rating', 'user_ratings_total'] },
    (results, status) => {
        if (status === 'OK' && results && results[0] && results[0].rating) {
            injectRating(`card${r.idx}`, results[0].rating, results[0].user_ratings_total);
        }
    });
});
document.getElementById('addPlaceForm').addEventListener('submit', handleAddPlace);
document.getElementById("catFilter").dispatchEvent(new Event('change'));

} // End of initPage function
</script>

<!-- IMPORTANT: Replace YOUR_API_KEY with your actual Google Maps API Key -->
<script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAKPWb_1blb8G_kwcJfQ2AVu0VvLYiTviM&libraries=places&callback=initPage"></script>

</body>
</html>
